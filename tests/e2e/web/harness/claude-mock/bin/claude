#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

const queueDir = process.env.FAKE_CLAUDE_QUEUE_DIR;

if (!queueDir) {
    process.stderr.write('FAKE_CLAUDE_QUEUE_DIR env var is not set\n');
    process.exit(1);
}

// Find the lowest-numbered .json file in the queue directory
let files;
try {
    files = fs.readdirSync(queueDir)
        .filter((f) => f.endsWith('.json') && f !== 'metadata.json')
        .sort();
} catch {
    process.stderr.write(`Failed to read queue directory: ${queueDir}\n`);
    process.exit(1);
}

if (files.length === 0) {
    process.stderr.write('Fake Claude CLI: queue is empty â€” no response files found. Did you call queueClaudeResponse() in your test?\n');
    process.exit(1);
}

const nextFile = path.join(queueDir, files[0]);
const raw = fs.readFileSync(nextFile, 'utf-8');
const response = JSON.parse(raw);

// Remove the consumed file from the queue
fs.unlinkSync(nextFile);

const lines = response.lines || [];
const exitCode = response.exitCode ?? 0;
const delayMs = response.delayMs ?? 10;

let index = 0;

function writeLine() {
    if (index >= lines.length) {
        process.exit(exitCode);
        return;
    }

    process.stdout.write(lines[index] + '\n');
    index++;

    if (index >= lines.length) {
        process.exit(exitCode);
    } else {
        setTimeout(writeLine, delayMs);
    }
}

writeLine();
